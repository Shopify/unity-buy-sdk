namespace <%= namespace %>.SDK {
    using System;
    using System.Text;
    using System.Reflection;
    using System.Collections;
    using System.Collections.Generic;

    public class ShopifyBuy {
        public static ShopifyClient Client() {
            return DefaultClient;
        }

        public static ShopifyClient Client(string domain) {
            if (ClientByDomain.ContainsKey(domain)) {
                return ClientByDomain[domain];
            } else {
                return null;
            }
        }

        public static ShopifyClient Init(string apiKey, string domain) {
            ClientByDomain[domain] = new ShopifyClient(apiKey, domain);

            if (DefaultClient == null) {
                DefaultClient = ClientByDomain[domain];
            }

            return ClientByDomain[domain];
        }

        public static ShopifyClient Init(ILoader loader, string domain = null) {
            if (domain != null) {
                ClientByDomain[domain] = new ShopifyClient(loader);

                if (DefaultClient == null) {
                    DefaultClient = ClientByDomain[domain];
                }

                return ClientByDomain[domain];
            } else {
                DefaultClient = new ShopifyClient(loader);

                return DefaultClient;
            }
        }

        private static ShopifyClient DefaultClient;
        private static Dictionary<string, ShopifyClient> ClientByDomain = new Dictionary<string, ShopifyClient>();
    }

    public delegate void ResponseProductsHandler(List<Product> products, List<string> errors, string httpError);
    delegate object GetNodeHandler(QueryRootQuery query);
    delegate void QueryNodeHandler(object node, string after);
    delegate object ResponseConnectionHandler(object response);

    public class ShopifyClient {
        QueryLoader Loader;

        public ShopifyClient(string apiKey, string domain) {
            #if UNITY_EDITOR
            Loader = new QueryLoader(new UnityLoader(domain, Base64(apiKey)));
            #endif
        }

        public ShopifyClient(ILoader loader) {
            Loader = new QueryLoader(loader);
        }

        public void products(ResponseProductsHandler callback, int? first = null, string after = null) {
            GetProductsList((products, errors, httpError) => {
                if (httpError != null) {
                    callback(null, null, httpError);
                } else if (errors != null) {
                    callback(null, errors, null);
                } else {
                    List<ConnectionInfo> connectionInfos = new List<ConnectionInfo>() { 
                        new ConnectionInfo(
                            getConnection: (p) => ((Product) p).images(),
                            query: (p, imagesAfter) => {
                                ((ProductQuery) p).images(ic => DefaultQueries.ImageConnection(ic),
                                    first: DefaultQueries.MaxPageSize, after: imagesAfter
                                );
                            }
                        ),
                        new ConnectionInfo(
                            getConnection: (p) => ((Product) p).variants(),
                            query: (p, variantsAfter) => {
                                ((ProductQuery) p).variants(vc => DefaultQueries.ProductVariantConnection(vc),
                                    first: DefaultQueries.MaxPageSize, after: variantsAfter
                                );
                            }
                        )
                    };

                    QueryConnectionsFromNode(products, connectionInfos, callback);
                }
            }, first: first, after: after);
        }

        private string GetAfter(object connection) {
            string after = null;
            
            Type connectionType = connection.GetType();
            
            MethodInfo pageInfoMethod = connectionType.GetMethod("pageInfo");
            PageInfo pageInfo = (PageInfo) pageInfoMethod.Invoke(connection, null);

            MethodInfo edgesMethod = connectionType.GetMethod("edges");
            
            if (pageInfo.hasNextPage()) {
                IList edges = edgesMethod.Invoke(connection, null) as IList;

                if (edges.Count > 0) {
                    object lastEdge = edges[edges.Count - 1];

                    MethodInfo cursorMethod = lastEdge.GetType().GetMethod("cursor");

                    after = (string) cursorMethod.Invoke(edges[edges.Count - 1], null);
                }
            }
        
            return after;
        }

        private object GetConnectionForProduct(string connectionName, object product) {
            MethodInfo methodConnection = product.GetType().GetMethod(connectionName);

            return methodConnection.Invoke(product, new object[] { null });
        }

        private struct ConnectionInfo {
            public ConnectionInfo(ResponseConnectionHandler getConnection, QueryNodeHandler query, string after = null) {
                GetConnection = getConnection;
                Query = query;
                After = after;
            }

            public string After;
            public ResponseConnectionHandler GetConnection;
            public QueryNodeHandler Query;
        }

        private List<ConnectionInfo> GetConnectionInfosToBuildQueriesFrom(List<ConnectionInfo> infos, object responseObject) {
            List<ConnectionInfo> infosToQuery = new List<ConnectionInfo>();

            foreach(ConnectionInfo info in infos) {
                object connection = info.GetConnection(responseObject);
                string after = GetAfter(connection);

                if (after != null) {
                    infosToQuery.Add(new ConnectionInfo(info.GetConnection, info.Query, after));
                }
            }

            return infosToQuery;
        }

        private void BuildProductQueryOnNode(QueryRootQuery query, List<ConnectionInfo> connectionInfosToBuildQuery, string productId, int productIdx) {
            query.node(n => n
                .onProduct((p) => {
                    p.id();

                    foreach(ConnectionInfo info in connectionInfosToBuildQuery) {
                        info.Query(p, info.After);
                    }
                }),
                id: productId, alias: String.Format("product{0}", productIdx)
            );
        }

        private void MergeConnections(object baseConnection, object connectionToMerge) {
            MethodInfo methodAddFromConnection = baseConnection.GetType().GetMethod("AddFromConnection");

            // this will merge connectionToMerge into baseConnection
            methodAddFromConnection.Invoke(baseConnection, new object[]{ connectionToMerge });
        }

        private void QueryConnectionsFromNode(List<Product> nodes, List<ConnectionInfo> connectionInfos, ResponseProductsHandler callback) {
            List<int> indicesQueried = new List<int>();
            List<List<ConnectionInfo>> connectionInfoQueried = new List<List<ConnectionInfo>>();
            QueryRootQuery query = new QueryRootQuery();

            for(int i = 0; i < nodes.Count; i++) {
                Node node = nodes[i];
                List<ConnectionInfo> connectionInfosToBuildQuery = GetConnectionInfosToBuildQueriesFrom(connectionInfos, node);
                
                if (connectionInfosToBuildQuery.Count > 0) {
                    indicesQueried.Add(i);
                    connectionInfoQueried.Add(connectionInfosToBuildQuery);
                    
                    BuildProductQueryOnNode(query, connectionInfosToBuildQuery, node.id(), i);
                }
            }

            if (indicesQueried.Count == 0) {
                callback(nodes, null, null);
            } else {
                Loader.Query(query, (response) => {
                    if (response.HTTPError != null) {
                        callback(null, null, response.HTTPError);
                    } else if (response.errors != null) {
                        callback(null, response.errors, null);
                    } else {
                        for(int i = 0; i < indicesQueried.Count; i++) {
                            int idxQueried = indicesQueried[i];
                            List<ConnectionInfo> infos = connectionInfoQueried[i];
                            object baseResult = nodes[idxQueried];
                            object resultToMerge = response.data.node(String.Format("product{0}", idxQueried));

                            foreach(ConnectionInfo info in infos) {
                                object baseConnection = info.GetConnection(baseResult);
                                object connectionToMerge = info.GetConnection(resultToMerge);

                                MergeConnections(baseConnection, connectionToMerge);
                            }
                        }

                        QueryConnectionsFromNode(nodes, connectionInfos, callback);
                    }
                });
            }
        }

        private void GetProductsList(ResponseProductsHandler callback, int? first = null, string after = null) {
            ConnectionLoader loader = new ConnectionLoader(Loader);
            int countToLoad = first == null ? int.MaxValue : (int) first;

            loader.Query(
                (response) => {
                    QueryRootQuery query = null;

                    List<ProductEdge> edges = response != null ? response.data.shop().products().edges() : null;

                    if (edges != null) {
                        countToLoad -= edges.Count;
                    }

                    if (response == null || (countToLoad > 0 && response.data.shop().products().pageInfo().hasNextPage())) {
                        query = new QueryRootQuery();
                        
                        query = new QueryRootQuery();
                        DefaultQueries.ShopProducts(
                            query: query, 
                            first: countToLoad > DefaultQueries.MaxPageSize ? DefaultQueries.MaxPageSize : countToLoad, 
                            after: edges != null ? edges[edges.Count - 1].cursor() : after
                        );
                    }

                    return query;
                },
                (firstResponse, response) => {
                    firstResponse.data.shop().products().AddFromConnection(
                        response.data.shop().products()
                    );

                    return firstResponse;
                },
                (response) => {
                    if (response.HTTPError != null) {
                        callback(null, null, response.HTTPError);
                    } else if (response.errors != null) {
                        callback(null, response.errors, null);
                    } else {
                        callback((List<Product>) response.data.shop().products(), null, null);
                    }
                }
            );
        }

        private string Base64(string apiKey) {
            return Convert.ToBase64String(Encoding.UTF8.GetBytes(apiKey));
        }
    }
}
