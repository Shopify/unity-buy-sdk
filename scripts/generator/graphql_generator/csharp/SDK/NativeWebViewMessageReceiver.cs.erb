namespace <%= namespace %>.SDK {
    using System;
    using System.Runtime.InteropServices;
    using <%= namespace %>.SDK;
    using <%= namespace %>.GraphQL;

    #if !SHOPIFY_MONO_UNIT_TEST
    using UnityEngine;
    public partial class NativeWebViewMessageReceiver: MonoBehaviour {}
    #endif

    public partial class NativeWebViewMessageReceiver {
        public ShopifyClient Client;
        public Checkout CurrentCheckout;

        public CheckoutSuccessCallback OnSuccess;
        public CheckoutCancelCallback OnCancelled;
        public CheckoutFailureCallback OnFailure;

        public void Init(
            ShopifyClient client,
            Checkout currentCheckout,
            CheckoutSuccessCallback onSuccess,
            CheckoutCancelCallback onCancelled,
            CheckoutFailureCallback onFailure)
        {

            Client = client;
            CurrentCheckout = currentCheckout;
            OnSuccess = onSuccess;
            OnCancelled = onCancelled;
            OnFailure = onFailure;
        }

        public void OnNativeMessage(string jsonMessage) {
            var message = NativeMessage.CreateFromJSON(jsonMessage);
            if (message.Content == "dismissed") {
                var query = new QueryRootQuery();
                query.node(
                    buildQuery: n => n
                        .onCheckout(c => c.completedAt()),
                    id: CurrentCheckout.id()
                );
                
                Client.Query(query, (response, error) => {
                    if (error != null) {
                        OnFailure(error);
                    } else {
                        var checkout = (Checkout) response.node();
                        if (checkout.completedAt() != null) {
                            OnSuccess();
                        } else {
                            OnCancelled();
                        }
                    } 
                });
            }
        }
    }
}
