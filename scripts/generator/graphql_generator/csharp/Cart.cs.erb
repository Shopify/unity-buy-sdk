namespace <%= namespace %> {
    using System;
    using System.Collections.Generic;
    using System.Text;
    using <%= namespace %>.SDK;
    using <%= namespace %>.GraphQL;

    /// <summary>
    /// This exception is thrown when interacting with a cart to add, update, or delete line items and no matching
    /// variant could be found.
    /// </summary>
    public class NoMatchingVariantException : Exception {
        public NoMatchingVariantException(string message) : base(message) {}
    }

    /// <summary>
    /// Manages line items for an order. Can also be used to generate a web checkout link to check out in browser.
    /// </summary>
    public partial class Cart {
        /// <summary>
        /// Current <see ref="CartLineItems">line items </see> for this <see ref="Cart">Cart </see>.
        /// </summary>
        public CartLineItems LineItems {
            get {
                return _LineItems;
            }
        }

        public List<UserError> UserErrors {
            get {
                return _UserErrors;
            }
        }

        private bool IsSaved {
            get {
                return IsCreated && LineItems.IsSaved;
            }
        }

        private bool IsCreated {
            get {
                return CurrentCheckout != null;
            }
        }

        private const float POLL_DELAY_SECONDS = 0.5f;
        private CartLineItems _LineItems;
        private List<UserError> _UserErrors = null;
        private List<String> DeletedLineItems = new List<string>();
        private ShopifyClient Client;
        private Checkout CurrentCheckout = null;
        

        /// <summary>
        /// Constructs a new cart using a <see ref="ShopifyClient">ShopifyClient </see>. Typically, carts won't be
        /// instantiated directly, but will rather be instatiated using <see ref="ShopifyClient.Cart">ShopifyBuy.Client().Cart() </see>.
        /// </summary>
        /// <param name="client">client associated with this cart</param>
        /// \code
        /// // Example that creates a cart using a ShopifyClient and checks how many line items it has
        /// // (spoiler: it has 0 line items since the cart was just created).
        /// ShopifyClient client = new ShopifyClient(accessToken, shopDomain);
        ///
        /// Cart cart = new Cart(client);
        ///
        /// Debug.Log(cart.LineItems.All().Count);
        /// \endcode
        public Cart(ShopifyClient client) {
            Client = client;
            _LineItems = new CartLineItems(OnDeleteLineItem);
        }

        public delegate void GetWebCheckoutLinkSuccess(string url);
        public delegate void GetWebCheckoutLinkFailure(ShopifyError error);

        public void GetWebCheckoutLink(GetWebCheckoutLinkSuccess success, GetWebCheckoutLinkFailure failure) {
            CheckoutSave(error => {
                if (error != null) {
                    failure(error);
                    return;
                }

                success(CurrentCheckout.webUrl());
            });
        }

        private void CheckoutSave(Action<ShopifyError> callback) {
            if (!IsCreated) {
                CheckoutCreate(callback);
            } else if(!IsSaved) {
                CheckoutUpdate(callback);
            } else {
                callback(null);
            }
        }

        private void CheckoutCreate(Action<ShopifyError> callback) {
            MutationQuery query = new MutationQuery();
            
            List<CheckoutLineItemInput> newLineItemInput = CartLineItems.ConvertToCheckoutLineItemInput(LineItems.All());
            
            DefaultQueries.checkout.Create(query, newLineItemInput);

            Client.Mutation(query, (Mutation response, ShopifyError error) => {
                if (error != null) {
                    callback(error);
                    return;
                }

                if (UpdateState(response.checkoutCreate().checkout(), response.checkoutCreate().userErrors())) {
                    if (CurrentCheckout.ready()) {
                        callback(null);
                    } else {
                        PollCheckoutAndUpdate(PollCheckoutReady, callback);
                    }
                } else {
                    HandleUserError(callback);
                }
            });
        }

        private void CheckoutUpdate(Action<ShopifyError> callback) {
            MutationQuery query = new MutationQuery();

            // remove all line items them add them
            List<string> lineItemsToRemove = CartLineItems.ConvertToLineItemIds(LineItems.All());
            lineItemsToRemove.AddRange(DeletedLineItems);

            List<CheckoutLineItemInput> lineItemsToAdd = CartLineItems.ConvertToCheckoutLineItemInput(LineItems.All());

            DefaultQueries.checkout.LineItemsRemove(query, CurrentCheckout.id(), lineItemsToRemove);
            DefaultQueries.checkout.LineItemsAdd(query, CurrentCheckout.id(), lineItemsToAdd);
        
            Client.Mutation(query, (Mutation response, ShopifyError error) => {
                if (error != null) {
                    callback(error);
                    return;
                }

                DeletedLineItems.Clear();

                if (UpdateState(response.checkoutLineItemsAdd().checkout(), response.checkoutLineItemsAdd().userErrors())) {
                    if (CurrentCheckout.ready()) {
                        callback(null);
                    } else {
                        PollCheckoutAndUpdate(PollCheckoutReady, callback);
                    }
                } else {
                    HandleUserError(callback);
                }
            });
        }

        private bool UpdateState(Checkout checkout) {
            return UpdateState(checkout, new List<UserError>());
        }

        private bool UpdateState(Checkout checkout, List<UserError> userErrors) {
            if (CurrentCheckout == null) {
                CurrentCheckout = checkout;
            } else {
                MergeCheckout merger = new MergeCheckout();

                CurrentCheckout = merger.Merge(CurrentCheckout, checkout);    
            }

            if (userErrors.Count > 0) {
                _UserErrors = userErrors;
            } else {
                _UserErrors = null;
            }

            UpdateLineItemFromCheckout(CurrentCheckout);

            return _UserErrors == null;
        }

        private void UpdateLineItemFromCheckout(Checkout checkout) {
            if (checkout == null) {
                return;
            }
            
            // sometimes we may not query line items for instance when polling is being performed
            try {
                List<CheckoutLineItem> lineItems = (List<CheckoutLineItem>) checkout.lineItems();

                LineItems.UpdateLineItemsFromCheckoutLineItems(lineItems);
            } catch(NoQueryException exception) {}
        }

        private void HandleUserError(Action<ShopifyError> callback) {
            ShopifyError error = new ShopifyError(
                ShopifyError.ErrorType.UserError,
                "There were issues with some of the fields sent. Checkout `cart.UserErrors`"
            );

            callback(error);
        }

        private void SetShippingLine(string shippingRateHandle, Action<ShopifyError> callback) {
            MutationQuery query = new MutationQuery();

            DefaultQueries.checkout.ShippingLineUpdate(query, CurrentCheckout.id(), shippingRateHandle);

            Client.Mutation(query, (Mutation response, ShopifyError error) => {
                if (error != null) {
                    callback(error);
                    return;
                }

                if (UpdateState(response.checkoutShippingLineUpdate().checkout(), response.checkoutShippingLineUpdate().userErrors())) {
                    if (CurrentCheckout.ready()) {
                        callback(null);
                    } else {
                        PollCheckoutAndUpdate(PollCheckoutReady, callback);
                    }
                } else {
                    HandleUserError(callback);
                }
            });
        }

        private void SetShippingAddressAndEmail(MailingAddressInput mailingAddressInput, string email, Action<ShopifyError> callback) {
            MutationQuery query = new MutationQuery();

            DefaultQueries.checkout.EmailUpdate(query, CurrentCheckout.id(), email);
            DefaultQueries.checkout.ShippingAddressUpdate(query, CurrentCheckout.id(), mailingAddressInput);

            Client.Mutation(query, (Mutation response, ShopifyError error) => {
                if (error != null) {
                    callback(error);
                } else {
                    if (UpdateState(response.checkoutEmailUpdate().checkout(), response.checkoutEmailUpdate().userErrors())) {
                        if (CurrentCheckout.availableShippingRates().ready()) {
                            callback(null);
                        } else {
                            PollCheckoutAndUpdate(PollCheckoutAvailableShippingRatesReady, callback);
                        }
                    } else {
                        HandleUserError(callback);
                    }
                }
            });
        }

        private void OnDeleteLineItem(string lineItemId) {
            DeletedLineItems.Add(lineItemId);
        }
    }
}
